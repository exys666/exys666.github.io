<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>exys666.com - Java string templates as SQL query</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="style.css" />
</head>
<body>
<header>
<nav>
    <h1><a href="/">exys666<span>.</span>com</a></h1>
    <ul>
        <li><a href="/posts.html">posts</a></li>
        <li><a href="mailto:exys666@gmail.com">mail</a></li>
        <li><a href="https://github.com/exys666">github</a></li>
        <li><a href="https://linkedin.com/in/exys666">linkedin</a></li>
    </ul>
</nav>
</header>
<article>
<time datetime="2023-11-07"><span>23</span><span>11</span><span>07</span></time>
<h1>Java string templates as SQL query</h1>
<h2>String templates</h2>
<p>Java 21 with <a href="https://openjdk.org/jeps/430">JEP 430</a> introduce <a href="https://docs.oracle.com/en/java/javase/21/language/preview-language-and-vm-features.html">preview feature</a> of <code>string templates</code>,
which is advanced version of <code>string interpolation</code> commonly known from other languages like JS or Python.</p>
<h2>Examples</h2>
<p>Here is simple example how string templates works.</p>
<pre class="language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Example</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">example</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> name <span class="token operator">=</span> <span class="token string">"exys666"</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token constant">STR</span><span class="token punctuation">.</span><span class="token string">"Hello \{ name }"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Unfortunately <a href="https://prismjs.com/">Prism</a> highlighter does not support yet new Java 21 features.</p>
<p><code>STR</code> is <code>Processor&lt;String, RuntimeException&gt;</code> static field in <code>java.lang.StringTemplate</code> interface.
There is also <a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/util/FormatProcessor.html#FMT">FMT</a>
and <a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/lang/StringTemplate.html#RAW">RAW</a>,
for more details follow links.</p>
<h2>Idea</h2>
<p>There is also option to create own template processor, just implement <code>java.lang.StringTemplate.Processor&lt;String, RuntimeException&gt;</code> interface.
Such implementation can also return different type then standard <code>String</code> class.</p>
<p>So, I thought why not to create custom template processor which will SQL query.
Of course string concatenation is very bad idea for creating SQL queries because of <a href="https://en.wikipedia.org/wiki/SQL_injection">SQL Injection</a>.
Proper solution should make use of <code>java.sql.PreparedStatement</code>.</p>
<h2>Proof of concept</h2>
<p><code>StringTemplate.Processor&lt;R,E extends Throwable&gt;</code> is <a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/lang/FunctionalInterface.html">@FunctionalInterface</a>, so it can be used as lambda.
<code>StringTemplate</code> interface provides <code>fragments()</code> method which return fragments of original template separated by interpolated part.
For example:</p>
<pre class="language-java"><code class="language-java"><span class="token class-name">String</span> name <span class="token operator">=</span> <span class="token string">"exys"</span><span class="token punctuation">;</span>
<span class="token constant">STR</span><span class="token punctuation">.</span><span class="token string">"Hello \{ name }, have a good day"</span><span class="token punctuation">;</span>
</code></pre>
<p>will return:</p>
<pre class="language-java"><code class="language-java"><span class="token class-name">List</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"Hello "</span><span class="token punctuation">,</span> <span class="token string">", have a good day"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p><code>PreparedStatement</code> accepts SQL query as a <code>String</code> with argument passed as <code>?</code>,
for example:</p>
<pre class="language-sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">WHERE</span> id <span class="token operator">=</span> ?
</code></pre>
<p>So, in order to create SQL query out of given template, all we have to do is join fragment using <code>?</code>.</p>
<pre class="language-java"><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Statement</span> <span class="token punctuation">{</span>

    <span class="token keyword">static</span> <span class="token class-name">StringTemplate<span class="token punctuation">.</span>Processor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PreparedStatement</span><span class="token punctuation">,</span> <span class="token class-name">SQLException</span><span class="token punctuation">></span></span> <span class="token function">prepare</span><span class="token punctuation">(</span><span class="token class-name">Connection</span> connection<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">StringTemplate</span> template<span class="token punctuation">)</span> <span class="token operator">-></span> connection<span class="token punctuation">.</span><span class="token function">prepareStatement</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">"?"</span><span class="token punctuation">,</span> template<span class="token punctuation">.</span><span class="token function">fragments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Query arguments are passed to <code>PreparedStatement</code> using set of dedicated setter methods.
<code>StringTemplate</code> interface provides <code>values()</code> method which return arguments as <code>List&lt;Object</code>.
All we had to do is write switch statement which calls right methods in <code>PreparedStatement</code> base on argument type.</p>
<pre class="language-java"><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Statement</span> <span class="token punctuation">{</span>

    <span class="token keyword">static</span> <span class="token class-name">StringTemplate<span class="token punctuation">.</span>Processor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PreparedStatement</span><span class="token punctuation">,</span> <span class="token class-name">SQLException</span><span class="token punctuation">></span></span> <span class="token function">prepare</span><span class="token punctuation">(</span><span class="token class-name">Connection</span> connection<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">StringTemplate</span> template<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">{</span>
            <span class="token keyword">var</span> statement <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">prepareStatement</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">"?"</span><span class="token punctuation">,</span> template<span class="token punctuation">.</span><span class="token function">fragments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> template<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">switch</span> <span class="token punctuation">(</span>template<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">case</span> <span class="token class-name">Integer</span> x <span class="token operator">-></span> statement<span class="token punctuation">.</span><span class="token function">setInt</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">case</span> <span class="token class-name">String</span> s <span class="token operator">-></span> statement<span class="token punctuation">.</span><span class="token function">setString</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">default</span> <span class="token operator">-></span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsupportedOperationException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">return</span> statement<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>So now we can use it like in this:</p>
<pre class="language-java"><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Example</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token class-name">PreparedStatment</span> <span class="token function">example</span><span class="token punctuation">(</span><span class="token class-name">Connection</span> connection<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> id <span class="token operator">=</span> <span class="token number">666</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Statement</span><span class="token punctuation">.</span><span class="token function">prepare</span><span class="token punctuation">(</span>connection<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token string">"SELECT * WHERE id = \{ id }"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Of course supporting all setter methods available in <code>PreparedStatement</code> will require more work.
I've created more completed example as java project <a href="https://github.com/exys666/statement-template">here</a>.</p>

</article>
</body>
</html>
